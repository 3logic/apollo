<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Apollo Index</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Apollo</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Apollo.html">Apollo</a>
						</li>
						
						<li>
							<a href="BaseModel.html">BaseModel</a>
						</li>
						
						<li>
							<a href="Model.html">Model</a>
						</li>
						
						<li>
							<a href="SingleNodePolicy.html">SingleNodePolicy</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#AERROR_TYPES">AERROR_TYPES</a>
						</li>
						
						<li>
							<a href="global.html#build_error">build_error</a>
						</li>
						
						<li>
							<a href="global.html#ERR_NAME_PREFIX">ERR_NAME_PREFIX</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
		<div class="span8">
			
				<div id="main">
					


	
	<span class="page-title">Index</span>
	
	












	
	





    <section class="readme-section">
        <article><h1>Apollo</h1>
<p><a href="https://travis-ci.org/3logic/apollo-cassandra"><img src="https://travis-ci.org/3logic/apollo-cassandra.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/r/3logic/apollo?branch=master"><img src="https://coveralls.io/repos/3logic/apollo/badge.png?branch=master" alt="Coverage Status"></a></p>
<p>Apollo is a <a href="http://cassandra.apache.org/" target="_blank">Cassandra</a> object modeling for <a href="http://nodejs.org/" target="_blank">node.js</a></p>
<h2>Notes</h2>
<p><em>Apollo is in early develeopment stage. Code and documentation are incomplete!</em></p>
<h2>Installation</h2>
<p><code>npm install apollo</code></p>
<h2>Usage</h2>
<p>Include Apollo and start creating your models</p>
<pre><code class="lang-javascript">var Apollo = require('apollo-cassandra');

var connection = {
    &quot;hosts&quot;: [
        &quot;127.0.0.1&quot;
    ],
    &quot;keyspace&quot;: &quot;my_keyspace&quot;
};

var apollo = new Apollo(connection);
apollo.connect(function(err){
    if(err) throw err;
    /* do amazing things! */
})</code></pre>
<h3>Connection</h3>
<p><code>Apollo</code> constructor takes two arguments: <code>connection</code> and <code>options</code>. Let's see what they are in depth:</p>
<ul>
<li><p><code>connection</code> are a set of options for your connection and accept the following parameters:</p>
<ul>
<li><code>hosts</code> is an array of string written in the form <code>host:port</code> or simply <code>host</code> assuming that the default port is 9042</li>
<li><code>keyspace</code> is the keyspace you want to use. If it doesn't exist apollo will create it for you</li>
<li><code>username</code> and <code>password</code> are used for authentication</li>
<li>Any other parameter is defined in <a href="#api">api</a></li>
</ul>
</li>
<li><p><code>options</code> are a set of generic options. Accept the following parameters:</p>
<ul>
<li><code>replication_strategy</code> can be an object or a string representing <a href="http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureDataDistributeReplication_c.html" target="_blank">cassandra replication strategy</a>. Default is <code>{'class' : 'SimpleStrategy', 'replication_factor' : 1 }</code></li>
</ul>
</li>
</ul>
<p>Here is a complete example: </p>
<pre><code class="lang-javascript">var apollo = new Apollo(
    {
       hosts: ['1.2.3.4', '12.3.6.5', 'cassandra.me.com:1212'],
       keyspace: 'mykeyspace',
       username: 'username',
       password: 'password'
    },
    {
        replication_strategy: {'class' : 'NetworkTopologyStrategy', 'dc1': 2 }
    }
);</code></pre>
<h2>Schema</h2>
<p>Now that apollo is connected, create a <code>model</code> describing it through a <code>schema</code></p>
<pre><code class="lang-javascript">var PersonSchema = {
    { 
        fields:{
            name    : &quot;text&quot;,
            surname : &quot;text&quot;,
            age     : &quot;int&quot;
        }, 
        key:[&quot;name&quot;] 
    }
};</code></pre>
<p>Now create a new Model based on your schema. The function <code>add_model</code> uses the table name and schema as parameters.</p>
<pre><code class="lang-javascript">var Person = apollo.add_model('person',PersonSchema);</code></pre>
<p>From your model you can query cassandra or save your instances</p>
<pre><code class="lang-javascript">/*Quesry your db*/
Person.find({name: 'jhon'}, function(err, people){
    if(err) throw err;
    console.log('Found ', people);
});

/*Save your instances*/
var alex = new Person({name: &quot;Alex&quot;, surname: &quot;Rubiks&quot;, age: 32});
alex.save(function(err){
    if(!err)
        console.log('Yuppiie!');
});</code></pre>
<h2>Schema in detail</h2>
<p>A schema can be a complex object. Take a look at this example</p>
<pre><code class="lang-javascript">PersonSchema = {
    &quot;fields&quot;: {
        &quot;id&quot;     : { &quot;type&quot;: &quot;uuid&quot;, &quot;default&quot;: {&quot;$db_function&quot;: &quot;uuid()&quot;} },
        &quot;name&quot;   : { &quot;type&quot;: &quot;varchar&quot;, &quot;default&quot;: &quot;no name provided&quot;},
        &quot;surname&quot;   : { &quot;type&quot;: &quot;varchar&quot;, &quot;default&quot;: &quot;no surname provided&quot;},
        &quot;complete_name&quot; : { &quot;type&quot;: &quot;varchar&quot;, &quot;default&quot;: function(){ return this.name + ' ' + this.surname;}},
        &quot;age&quot;    :  { &quot;type&quot;: &quot;int&quot; },
        &quot;created&quot;     : {&quot;type&quot;: &quot;timestamp&quot;, &quot;default&quot; : {&quot;$db_function&quot;: &quot;now()&quot;} }
    },
    &quot;key&quot; : [[&quot;id&quot;],&quot;created&quot;],
    &quot;indexes&quot;: [&quot;name&quot;]
}</code></pre>
<p>What does the above code means?
- <code>fields</code> are the columns of your table. For each column name the value can be the type or an object containing more specific informations. i.e.
    + <code>&quot;id&quot;     : { &quot;type&quot;: &quot;uuid&quot;, &quot;default&quot;: {&quot;$db_function&quot;: &quot;uuid()&quot;} },</code> in this example id type is <code>uuid</code> and the default value is a cassandra function (so it will be executed from the database). 
    + <code>&quot;name&quot;   : { &quot;type&quot;: &quot;varchar&quot;, &quot;default&quot;: &quot;no name provided&quot;},</code> in this case name is a varchar and, if no value will be provided, it will have a default value of <code>no name provided</code>. The same goes for <code>surname</code>
    + <code>complete_name</code> the default values is calculated from others field. When apollo processes you model instances, the <code>complete_name</code> will be the result of the function you defined. In the function <code>this</code> is the current model instance.
    + <code>age</code> no default is provided and we could write it just as <code>&quot;age&quot;: &quot;int&quot;</code>
    + <code>created</code>, like uuid(), will be evalueted from cassandra using the <code>now()</code> function
- <code>key</code>: here is where you define the key of your table. As you can imagine, the first value of the array is the <code>partition key</code> and the others are the <code>clustering keys</code>. The <code>partition key</code> can be an array defining a <code>compound key</code>. Read more about keys on the <a href="http://www.datastax.com/documentation/cql/3.1/cql/cql_using/use_compound_keys_t.html" target="_blank">documentation</a>
- <code>indexes</code> are the index of your table. It's always an array of field names. You can read more on the <a href="http://www.datastax.com/documentation/cql/3.1/cql/ddl/ddl_primary_index_c.html" target="_blank">documentation</a></p>
<h2>Generating your model</h2>
<p>A model is an object representing your cassandra <code>table</code>. Your application interact with cassandra through your models. An instance of the model represents a <code>row</code> of your table.</p>
<p>Let's create our first model</p>
<pre><code class="lang-javascript">var Person = apollo.add_model('person',PersonSchema);</code></pre>
<p>now instantiate a person</p>
<pre><code class="lang-javascript">var john = new Person({name: &quot;John&quot;, surname: &quot;Doe&quot;});</code></pre>
<p>When you instantiate a model, every field you defined in schema is automatically a property of your instances. So, you can write:</p>
<pre><code class="lang-javascript">john.age = 25;
console.log(john.name); //John
console.log(john.complete_name); // undefined.</code></pre>
<p><strong>note</strong>: <code>john.complete_name</code> is undefined in the newly created instance but will be populated when the instance is saved because it has a default value in schema definition</p>
<p>John is a well defined person but he is not still persisted on cassandra. To persist it we need to save it. So simple:</p>
<pre><code class="lang-javascript">john.save(function(err){
    if(err)
        return 'Houston we have a problem';
    else
        return 'all ok, saved :)';

});</code></pre>
<p>When you save an instance all internal validators will check you provided correct values and finally will try to save the instance on cassandra.</p>
<p>Ok, we are done with John, let's delete it:</p>
<pre><code class="lang-javascript">john.delete(function(err){
    //...
});</code></pre>
<p>ok, goodbye John.</p>
<h2>Virtual fields</h2>
<p>Your model could have some fields which are not saved on database. You can define them as <code>virtual</code></p>
<pre><code class="lang-javascript">PersonSchema = {
    &quot;fields&quot;: {
        &quot;id&quot;     : { &quot;type&quot;: &quot;uuid&quot;, &quot;default&quot;: {&quot;$db_function&quot;: &quot;uuid()&quot;} },
        &quot;name&quot;   : { &quot;type&quot;: &quot;varchar&quot;, &quot;default&quot;: &quot;no name provided&quot;},
        &quot;surname&quot;   : { &quot;type&quot;: &quot;varchar&quot;, &quot;default&quot;: &quot;no surname provided&quot;},
        &quot;&quot;
        &quot;complete_name&quot; : { 
            &quot;type&quot;: &quot;varchar&quot;, 
            &quot;virtual&quot; : { 
                get: function(){return this.name + ' ' +this.surname;},
                set: function(value){
                    value = value.split(' ');
                    this.name = value[0]; 
                    this.surname = value[1];
                }
            }
        },
    }
}</code></pre>
<p>A virtual field is simply defined adding a <code>virtual</code> key in field description. Virtuals can have a <code>get</code> and a <code>set</code> function, both optional (you should define at least one of them!).
<code>this</code> inside get and set functions is bound to current instance of your model.</p>
<h2>Validators</h2>
<p>Every time you set a property for an instance of your model, internal type validator check that the value is valid. If not an error is thrown. But how to add a custom validator? You need to provide your custom validator in the schema definition. For example, if you want to check age to be a number greater than zero:</p>
<pre><code class="lang-javascript">var PersonSchema = {
    //... other properties hidden for clarity
    age: {
        type : &quot;int&quot;,
        rule : function(value){ return value &gt; 0; }
    }
}</code></pre>
<p>your validator must return a boolean. If someone will try to assign <code>jhon.age = -15;</code> an error will be thrown.
You can also provide a message for validation error in this way</p>
<pre><code class="lang-javascript">var PersonSchema = {
    //... other properties hidden for clarity
    age: {
        type : &quot;int&quot;,
        rule : {
            validator : function(value){ return value &gt; 0; },
            message   : 'Age must be greater than 0'
        }
    }
}</code></pre>
<p>Than the error will have your message. Message can also be a function; in that case it must return a string:</p>
<pre><code class="lang-javascript">var PersonSchema = {
    //... other properties hidden for clarity
    age: {
        type : &quot;int&quot;,
        rule : {
            validator : function(value){ return value &gt; 0; },
            message   : function(value){ return 'Age must be greater than 0. You provided '+ value; }
        }
    }
}</code></pre>
<p>The error message will be <code>Age must be greater than 0. You provided -15</code></p>
<h2>Querying your data</h2>
<p>Ok, now you have a bunch of people on db. How to retrieve them?</p>
<h3>Find</h3>
<pre><code class="lang-javascript">Person.find({name: 'John'}, function(err, people){
    if(err) throw err;
    console.log('Found ', people);
});</code></pre>
<p>In the above example it will perform the query <code>SELECT * FROM person WHERE name='john'</code> but <code>find()</code> allows you to perform even more complex queries on cassandra.  You should be aware of how to query cassandra. Every error will be reported to you in the <code>err</code> argument, while in <code>people</code> you'll find instances of <code>Person</code>. If you don't want apollo to cast results in instances of your model you can use the <code>raw</code> option as in the following example</p>
<pre><code class="lang-javascript">Person.find({name: 'John'}, { raw: true }, function(err, people){
    //people is an array of plain objects
});</code></pre>
<p>Let's see a complex query</p>
<pre><code class="lang-javascript">var query = {
    name: 'John', // stays f
    or name='john' 
    age : { '$gt':10 }, // stays for age&gt;10 You can also use $gte, $lt, $lte
    surname : { '$in': ['Doe','Smith'] }, //This is an IN clause
    $orderby:{'$asc' :'age'} }, //Order results by age in ascending order. Also allowed $desc and complex order like $orderby:{'$asc' : ['k1','k2'] } }
    $limit: 10 //limit result set

}</code></pre>
<p>Note that all query clauses must be Cassandra compliant. You cannot, for example, use $in operator for a key which is not the partition key. Querying in Cassandra is very basic but could be confusing at first. Take a look to this <a href="http://mechanics.flite.com/blog/2013/11/05/breaking-down-the-cql-where-clause/" target="_blank">post</a> and, obvsiouly, to the <a href="http://www.datastax.com/documentation/cql/3.1/cql/cql_using/about_cql_c.html" target="_blank">documentation</a></p>
<h2>Api</h2>
<p>Complete api definition is available on <a href="http://apollo.3logic.it/Apollo.html" target="_blank">3logic website</a>.
Anyway you can generate documentation cloning this project and launching <code>grunt doc</code></p>
<h2>Test</h2>
<p>To test Apollo create a file named <code>local_conf.json</code> in <code>test</code> directory with your connection configuration as below</p>
<pre><code class="lang-json">{
    &quot;contactPoints&quot;: [
       &quot;127.0.0.1&quot;,
       &quot;192.168.100.65&quot;,
       &quot;my.cassandra.com:9845&quot;
    ],
    &quot;keyspace&quot;: &quot;tests&quot;
}</code></pre>
<h2>About</h2>
<p>Apollo is brought to you by</p>
<ul>
<li><a href="https://github.com/bionicco">Niccolò Biondi</a></li>
<li><a href="https://github.com/ecogodi">Elia Cogodi</a></li>
<li><a href="https://github.com/ramiel">Fabrizio Ruggeri</a></li>
</ul>
<p>Thanks to <em>Gianni Cossu</em> and <a href="https://github.com/amaxis">Massimiliano Atzori</a> for helping.</p>
<p>Thanks to <a href="http://www.3logic.it">3logic</a> too!</p></article>
    </section>







				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Apollo - 3logic Copyright © 2014-2015
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a>
		on Tue Oct 14th 2014 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<div class="span3">
				<div id="toc"></div>
			</div>
			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	
	<script>
		(function ( i, s, o, g, r, a, m ) {
			i['GoogleAnalyticsObject'] = r;
			i[r] = i[r] || function () {
				(i[r].q = i[r].q || []).push( arguments )
			}, i[r].l = 1 * new Date();
			a = s.createElement( o ),
				m = s.getElementsByTagName( o )[0];
			a.async = 1;
			a.src = g;
			m.parentNode.insertBefore( a, m )
		})( window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga' );

		ga( 'create', 'UA-152979-11', 'apollo.3logic.it' );
		ga( 'send', 'pageview' );
	</script>
	

</body>
</html>